\documentclass[10pt,a4paper]{jarticle}

\newcommand{\thetitle}{vCloud Datacenter Toolkit - Users Guide}
\newcommand{\theauthor}{Kaoru Fukumoto}
\newcommand{\email}{kfukumot@vmware.com}
\newcommand{\version}{1.1}
\newcommand{\customer}{SoftBank Telecom}
\newcommand{\COMMON}{../common}

\input{\COMMON/packages}
\input{\COMMON/style}
\usepackage{booktabs}
\usepackage{hyperref}

\begin{document}
\CoverPage

\pagenumbering{roman}
\section*{改版履歴}
\begin{tabular}{|cccp{7cm}|}
\hline
\rowcolor[gray]{.8} \textbf{変更日} & 
\textbf{\small バージョン} & 
\textbf{変更者} & 
\textbf{コメント}\\

2011/08/18 & 1.0 & 福本　薫 & 
最初のバージョン\\

2011/08/25 & 1.1 & 福本　薫 & 
データアーカイビングの項追加\\

2011/09/20 & 1.2 & 福本　薫 & 
vCloud API v1.5サポート。vcd-trend.rb: レポートデータ収集期間の変更、メール送信対応、最大値タイムスタンプフィールド追加。
vsp-datastore.rb: データストア監視スクリプトの追加\\

\hline
\end{tabular}

\newpage
\tableofcontents

\newpage
\pagenumbering{arabic}
\section{インストール}

\subsection{システム要件}
vcdkitをインストールするためには各種Liunx系OSもしくはMac OSXと以下のruby実行環境が必要です。
\begin{itemize}
\item ruby (version 1.8.7 以降)
\item ruby gem (version 1.3.5 以降)
\item ruby gem パッケージ
  \begin{itemize}
  \item crypt 
  \item highline
  \item rbvmomi
  \item rest-client
  \item pony
  \end{itemize}
\end{itemize}

本バージョンのvcdkitは以下のvCloudソフトウェアのバージョンをサポートします。
\begin{itemize}
\item vCloud Directory (version 1.0.1, 1.5)
\item vSphere (version 4.1)
\end{itemize}

\subsection{インストール手順}
\label{sec:install}
vcdkit のインストールは vcdkit を利用する一般ユーザアカウントで行います。root 権限は必要ありません。
\begin{enumerate}
\item 配布パッケージ(vcdkit-\$VERSION.zip)をインストール先サーバのローカルディスクにコピー
\item 配布パッケージをインストールディレクトリ配下に展開\\
/tmpディレクトリにコピーされた配布パッケージを/opt/vmware/vcdkitディレクトリにインストールする例を以下に示します。
以下インストールディレクトリを\$VCDKITとして参照します。
\begin{verbatim}
$ cd /opt/vmware/vcdkit
$ unzip /tmp/vcdkit-$VERSION.zip
\end{verbatim}

\item 環境変数 VCDKITを設定\\
vcdkitのコマンドを実行するためには環境変数 \$VCDKIT を設定する必要があります。
また、すべてのコマンドは \$VCDKIT ディレクトリ直下にインストールされるので、
PATH変数に \$ VCDKITを追加する事をお勧めします。.bashrcの編集例を以下に示します。
 \begin{verbatim}
export VCDKIT=/opt/vmware/vcdkit
export PATH=$VCDKIT:$PATH
\end{verbatim}

\item 暗号化されたパスワードの保存。\\
vCloud Datacenterの各種システムへ接続する際に使用するパスワードを、暗号化した上でローカルディスクに保存します。
保存されたパスワードファイルは vcdkit 利用アカウントと root アカウントのみが読み取り出来るように設定する事を推奨します。
以下に設定例を示します。パスワードファイルはシステム毎に\$VCDKITディレクトリ直下に保存されます。

{\footnotesize
 \begin{verbatim}
$ vcd-pass.rb -h
Usage: vcd-pass.rb [options]
    -v, --vcd                        Change login password for vCloud Director
    -c, --vcenter                    Change login password for vCenter
    -e, --esx                        Change login password for ESX
    -b, --chargeback                 Change login password for vCenter Chargeback
    -l, --logfile LOGFILEPATH        Log file name
    -h, --help                       Display this help
$ vcd-pass.rb -vc
Enter vCloud Director password: ********
Enter vCenter password: ********
$ chmod go-r $VCDKIT/.vc # password for vCloud Director
$ chmod go-r $VCDKIT/.vcd # password for vCenter
\end{verbatim}
}

\item cronジョブの設定。\\
vApp設定のリストアを行うためにバックアップジョブのスケジュールと同期して vcd-dump.rbを実行します。
\$VCDKIT/cron/crontab.conf には標準的な毎時バックアップのスケジュール例が記述されています。
crontab.conf を適切に編集後、crontab コマンドで cron ジョブをスケジュールします。

{\footnotesize
 \begin{verbatim}
$ crontab $VCDKIT/cron/crontab.conf
$ crontab -l
0 * * * * /opt/vmware/vcdkit/cron/vcd-dump.sh
15 * * * * /opt/vmware/vcdkit/cron/vcd-report.sh
30 * * * * /opt/vmware/vcdkit/cron/archive.sh
0 1 1 * * /opt/vmware/vcdkit/cron/vcd-trend.sh
0 2 * * * /opt/vmware/vcdkit/cron/vcd-ex.sh
\end{verbatim}
}

\end{enumerate}

\section{コマンド} 
%
% vcd-dump.rb
%
\subsection{vcd-dump.rb} 
vCloud DirectorとvCenterからデータの抽出を行います。

\subsubsection{使用例}
\paragraph{フェーズ２本番環境すべてのデータを自動タイムスタンプ付きディレクトリにダンプする}

\begin{verbatim}
$ vcd-dump-rb -v1 -c1 -l $VCDKIT/logs/vcd-dump.log
\end{verbatim}

\begin{itemize}
\item {\tt -v1, -c1} オプションは vCloud Director, vCenter 共にフェーズ２本番環境の
サーバおよび接続アカウントを利用する事を指定します。以下の{\tt -v, -c}オプションを指定する事と同等です。

\begin{verbatim}
$ vcd-dump-rb \
   -v vcd.vcdc.whitecloud.jp,System,vcloud-sc \
   -c 10.128.0.57,vcloud-vcd \
   -l $VCDKIT/logs/vcd-dump.log
\end{verbatim}

\item コマンド引数フォーマットの詳細については\ref{sec:vcd-dump-opts}を参照下さい。
\item 接続に用いるパスワードはコマンド引数では指定しません。パスワードの設定／保存方法については\ref{sec:install}を参照下さい。
\item ダンプデータはデフォルトで \$VCDKIT/data/vcd-report/TIMESTAMP 以下に保存されます。
\item TIMESTAMP 名の生成にはコマンド実行開始時の時間が利用されます。（例：2011-07-20\_12-00-00）
\item {\tt -l} オプションはログ出力先ファイルを指定します。無指定の場合は標準出力に出力されます。
\end{itemize}


\subsubsection{データファイルの構造}
vcd-dump.rb は \$VCDKIT/data/vcd-dump/TIMESTAMP 配下に以下の形で抽出データをダンプします。
データファイルはすべて vCloud API を用いて取得されるオブジェクト毎の XML形式です。
\footnote{XMLデータの詳細についてはvCloud APIの仕様を参照ください。
\url{http://communities.vmware.com/community/vmtn/developer/forums/vcloudapi}}

{\footnotesize
\begin{verbatim}
$VCDKIT/data/vcd-dump/TIMESTAMP
`-- ORG
  |-- VCD.xml
  |-- VCenter.xml
  `-- [Org Name]
     |-- Org.xml
     |-- VDC
     | `-- [vDC Name]
     |   |-- Vdc.xml
     |   |-- VAPP
     |   | `-- [vApp Name]
     |   |   |-- VApp.xml
     |   |   |-- ControlAccessParams.xml
     |   |   `-- VM
     |   |     `-- [VM Name]
     |   |       `-- Vm.xml     
     |   `-- VAPPTEMPLATE
     |     `-- [vApp Template Name]
     |       |-- VAppTemplate.xml
     |       `-- VMTEMPLATE
     |         `-- [VM Template Name]
     |            `-- VmTempalte.xml     
     |-- CATALOG
     | `-- Public
     |    |-- Catalog.xml
     |    `-- CATALOGITEM
     |      `-- [Catalog Item Name]
     |        `-- CatalogItem.xml
     `-- USER
       `-- [User Name]
         `-- User.xml
\end{verbatim}
}

\subsubsection{コマンドオプション一覧}
\label{sec:vcd-dump-opts}
利用できるコマンドオプションの一覧は引数に{\tt -h}を指定すると表示されます。

{\footnotesize
\begin{verbatim}
$ vcd-dump.rb -h
Usage: vcd-dump.rb [options]
    -v, --vcd HOST,ORG,USER          vCD login parameters
    -c, --vcenter HOST,USER          vCenter login parameters
    -A, --all                        Dump all data
    -a, --vapp ORG,VDC,VAPP          Dump specified vApp data
    -o, --org ORG                    Dump specified organization data
    -t, --tree TREENAME              Dump tree directory name
    -l, --logfile LOGFILEPATH        Log file name
    -h, --help                       Display this help
\end{verbatim}
}

%
% vcd-report.rb
%
\subsection{vcd-report.rb} 
vcd-dump.rb で抽出した XMLデータをもとに各種レポート作成します。

\subsubsection{使用例}
\paragraph{レポート未作成のすべてのダンプデータからレポートを作成する}

\begin{verbatim}
$ vcd-report.rb
\end{verbatim}

\begin{itemize}
\item \$VCDKIT/data/vcd-dump以下のすべてのディレクトリを検索し（TIMESTAMPを保持した形で）
同じディレクトリ構成で \$VCDKIT/data/vcd-report 以下にレポートを作成します。
（例：\$VCDKIT/data/vcd-dump/2011-07-01\_00-00-00
のレポートを \$VCDKIT/data/vcd-report/2011-07-01\_00-00-00に作成）
\item デフォルトでは 既にレポート作成が行われているダンプデータはスキップされます。強制的に
レポートの再作成を行う場合には{\tt -f (--force)}オプションを指定します。
\item コマンドオプションの詳細については\ref{sec:vcd-report-opts}を参照下さい。
\end{itemize}

\subsubsection{データファイルの構造}
vcd-report.rb は \$VCDKIT/data/vcd-report 配下に以下の形で各種レポートファイルを作成します。

{\footnotesize
\begin{verbatim}
$VCDKIT/data/vcd-report/TIMESTAMP
`-- ORG
   |-- VMList.xml
   |-- MediaList.xml
   `-- [Org Name]
     `-- VDC
       `-- [vDC Name]
         |-- VAPP
         | `-- [vApp Name]
         |   |-- VAppParams.xml
         |   `-- VM
         |     `-- [VM Name]
         |       `-- VmParams.xml     
         `-- VAPPTEMPLATE
           `-- [vApp Template Name]
             |-- VAppTemplateParams.xml
             `-- VMTEMPLATE
               `-- [VM Template Name]
                  `-- VmTemplateParams.xml     

\end{verbatim}
}

\subsubsection{作成されるレポートの種類}

\begin{table}[H]
\begin{tabular}{lm{6.5cm}}
\toprule
\textbf{ファイル名}　& \textbf{説明} \\ 
\midrule
VMList.xml & 仮想マシンのインベントリ一覧 \\
MediaList.xml & メディアのインベントリ一覧 \\
vAppParams.xml & vAppのパラメータ一覧 \\
VmParams.xml  & vApp内仮想マシンのパラメータ一覧 \\
vAppTemplateParams.xml & vApp Templateのパラメータ一覧 \\
VmTemplateParams.xml & vApp Template内仮想マシンのパラメータ一覧 \\
\bottomrule
\end{tabular}
\end{table}

\subsubsection{コマンドオプション一覧}
\label{sec:vcd-report-opts}
利用できるコマンドオプションの一覧は引数に{\tt -h}を指定すると表示されます。

{\footnotesize
\begin{verbatim}
$ vcd-report.rb -h
Usage: vcd-report.rb [cmd-options]
    -v, --vcd HOST,ORG,USER          vCD login parameters
    -i, --input DIR                  Specify root directory of the vCD dump data
    -o, --output DIR                 Specify directory for reports
    -a, --vapp ORG,VDC,VAPP          Create report for vApp
    -T ORG,VDC,VAPPTEMPLATE          Create report for vApp Template
        --vapptemplate
    -A, --all                        Create report for entire dump tree
    -t, --tree TREENAME              Directory name to identify dump tree
    -f, --force                      Force to recreate reports to exisiting tree
    -l, --logfile LOGFILEPATH        Log file name
    -h, --help                       Display this help
\end{verbatim}
}

%
% vcd-restore.rb
%
\subsection{vcd-restore.rb} 
vcd-dump.rb で抽出した XMLデータをもとにvApp設定情報のリストアを行います。

\subsubsection{使用例}
\paragraph{リストア日時とvApp名を指定してvApp設定情報をリストアする（インタラクティブモード）}

\subparagraph{ステップ1:  ターゲットの指定}

{\footnotesize
\begin{verbatim}
$ vcd-report.rb
Select restart target directory:
1. 2011-07-26_20-04-10
2. Specify date
3. Change name pattern. Current pattern='*'
?  1
Enter vApp name pattern: RESTORE
Select VAPP:
1. CustomerDemo-02 | Basic Backup - Customer Demo-02 | RESTORE-000
2. CustomerDemo-02 | Basic Backup - Customer Demo-02 | RESTORE-001
3. Change name pattern. Current pattern='*RESTORE*'
?  2
\end{verbatim}
}

\subparagraph{ステップ2:  現時点での差分表示、およびリストア実行の確認}

{\footnotesize
\begin{verbatim}
...
（vApp情報取得動作のログ）
...
***************
*** 4,10 ****
        DB-02
      </FullName>
      <Description>
!       Testing..
      </Description>
      <OperatingSystemType>
         winNetEnterpriseGuest 
--- 4,10 ----
        DB-02
      </FullName>
      <Description>
!       CHANGE DESCRIPTION
      </Description>
      <OperatingSystemType>
         winNetEnterpriseGuest 
<<
Continue (yN)? y
\end{verbatim}
}

\subparagraph{ステップ3: リストア実施、およびリストア完了後の差分表示}
{\footnotesize
\begin{verbatim}
...
（vAppリストア動作のログ）
...
2011-07-26 21:22:03 | INFO | [DIFF AFTER RESTORE]: >><<
\end{verbatim}
}

\subsubsection{コマンドオプション一覧}
利用できるコマンドオプションの一覧は引数に{\tt -h}を指定すると表示されます。

{\footnotesize
\begin{verbatim}
$ vcd-restore.rb -h
Usage: vcd-restore.rb [cmd-options]
    -v, --vcd HOST,ORG,USER          vCD login parameters
    -i, --input DIR                  Root directory of the vCD dump data
    -t, --tree TREENAME              Directory name to identify dump tree
    -o, --output DIR                 Specify directory for reports
    -a, --vapp ORG,VDC,VAPP          Restore source vApp
    -l, --logfile LOGFILEPATH        Log file name
    -h, --help                       Display this help

\end{verbatim}
}

%
% vcd-trend.rb
%
\subsection{vcd-trend.rb} 
vcd-report.rb で作成したレポートデータをもとにトレンド分析を行うための各種レポートを作成しメールで送信します。

\subsubsection{使用例}
\paragraph{既存のレポートデータからWindowsゲストOSの使用状況リストを作成する}

\begin{verbatim}
$ vcd-trend.rb
\end{verbatim}

\begin{itemize}
\item \$VCDKIT/data/vcd-report以下のすべてのディレクトリを検索し、前月分のトレンドレポートを作成します。
\begin{quote}
例：\\
\$VCDKIT/data/vcd-report 配下に 2011-07-15\_00-00-00 から 2011-09-20\_00-00-00までのレポートディレクトリがある時に
2011年9月21日にスクリプトを実行した場合、前月分である2011年8月1日から2011年8月31日のデータを対象としたトレンドレポートを
\$VCDKIT/data/vcd-trend/2011-08-01\_00-00-00\_\_2011-08-31\_23-00-00配下に作成します。
\end{quote}

\end{itemize}

\subsubsection{作成されるレポートの種類}

\begin{table}[H]
\begin{tabular}{lm{7.5cm}}
\toprule
\textbf{ファイル名}　& \textbf{説明} \\ 
\midrule
GuestList.xml & 各VDC毎/各ゲストOS毎のVM数の内訳（最少数、最大数、最大数をとった時の最古の時刻、平均値）\\
GuestSummary.xml & 各ORG毎/各ゲストOSタイプ(サーバ系Windows、非サーバ系Windows、非Windowsの３種類)毎のVM数の内訳（最少数、最大数、最大数をとった時の最古の時刻、平均値）\\
\bottomrule
\end{tabular}
\end{table}

%
% vcd-ex.rb
%
\subsection{vcd-ex.rb}
vCloud Director Cell と vCenter 間、および vCloud Director Cellと ESXホスト間のセッションを維持するために以下の操作を行います。

\begin{itemize}
\item vAppのリスタート
\item 仮想マシンサムネールの取得
\end{itemize}

このコマンドはファイアウォールによるアイドルコネクションタイムアウトによる接続障害を回避する目的で
使用されます。ファイアウォールのタイムアウト間隔より十分短い間隔で実行する必要があります。

\subsubsection{操作対象となるvApp}

vCloud Director CellとすべてのESXi ホスト間でのセッションを維持するために、各ESXiに
サムネール取得対象のVMを配置する必要があります。以下に現在の配置状どl１ph態を記します。
各仮想マシンはDRSのアフィニティルールを用いてホストに紐付けされています。

\begin{table}[H]
\begin{tabular}{lllll}
\toprule
\textbf{VDC} & \textbf{VAPP} & \textbf{VM} & \textbf{ESX} \\ 
\midrule
Basic - Admin & VCDEX-B01 & VCDEX-158$\sim$ &  CGSdhb-158$\sim$ \\
 &  & VCDEX-171 &  CGSdhb-171 \\
Basic Backup - Admin & VCDEX-BB01 & VCDEX-172$\sim$ &  CGSdhb-172$\sim$ \\
 &  & VCDEX-177 &  CGSdhb-177 \\
Committed - Admin & VCDEX-C01 & VCDEX-138$\sim$ &  CGSdhb-138$\sim$ \\
 &  & VCDEX-151 &  CGSdhb-151 \\
Committed Backup - Admin & VCDEX-CB01 & VCDEX-152$\sim$ &  CGSdhb-152$\sim$ \\
 &  & VCDEX-157 &  CGSdhb-157 \\
\bottomrule
\end{tabular}
\end{table}

%
% vsp-datastore.rb
%
\subsection{vsp-datastore.rb}
ESXホストとNFSデータストア間の正常接続を監視するために、NFSデータストアに対してディレクトリ作成／削除の操作を行います。

\subsubsection{操作対象となるESXホストおよびデータストア}
監視対象となるvCenterの接続情報もしくはホストとデータストアのリストを定義した構成ファイルを指定します。

vCenterの接続情報を指定した場合には、そのvCenter配下のすべてのESXホスト、および各ESXホストに
マウントされているすべてのデータストアが操作対象となります。

ホストとデータストアの構成ファイルは以下のフォーマットのXMLで定義します。
\begin{verbatim}
<?xml version="1.0" encoding="UTF-8"?>
<dslist>
  <esx>host-1</esx>
  <esx>host-2</esx>
          ...
  <esx>host-N</esx>
  <datastore>datastore-1</datastore>
  <datastore>datastore-2</datastore>
          ...
  <datastore>datastore-N</datastore>
</dslist>
\end{verbatim}

\subsubsection{使用例}
\paragraph{vCenterを指定して構成ファイルのテンプレートを出力する}

\begin{verbatim}
$ vsp-datastore.rb -c1
\end{verbatim}

\begin{itemize}
\item {\tt -c1} オプションは接続先のvCenterとしてフェーズ２本番環境のvCenterサーバを指定します。
\item 標準出力にホストとデータストアのリストが構成ファイルのフォーマットで出力されます。
\item データストアに対してディレクトリ作成などの変更操作は行いません。
\item 出力された構成ファイルをコマンド引数として用いるためには、ローカルのデータストアの削除などの編集を適時行う必要があります。
\end{itemize}

\paragraph{構成ファイルを指定してデータストアへのアクセステストを行う}

\begin{verbatim}
$ vsp-datastore.rb -C $CONFFILE -D -l $VCDKIT/logs/vsp-datastore.log
\end{verbatim}

\begin{itemize}
\item {\tt -D} オプションは各データストアに対してテンポラリディレクトリの作成と削除を実施する事を指定します。
\item データストア操作の実行結果は指定したログファイルに記録されます。失敗操作はエラーログとして記録されます。
\end{itemize}

\section{管理}
\subsection{データアーカイビング}
vcdkitインストール時に、以下のスクリプト(\$VCDKIT/cron/archive.sh)が毎時30分に実行するように設定されます。
{\footnotesize 
\begin{verbatim}
     1	#!/bin/sh
     2	
     3	export VCDDATA=/opt/vmware/vcdkit/data
     4	
     5	archive() {
     6	    tooldir=$1
     7	    days=$2
     8	
     9	    for t in `find $VCDDATA/$tooldir -maxdepth 1 -mindepth 1 -mtime +$days -type d`
    10	    do
    11          file=`basename $t`
    12	         dir=`dirname $t`
    13	         echo "Creating tar archive: $t"
    14	         tar zcf $dir/$file.tgz -C $dir $file && \
    15	            rm -fr $t && \
    16	            mv $dir/$file.tgz $VCDDATA/$tooldir/archive
    17	    done
    18	}
    19	
    20	# Archive vcd-dump data which is older than 7 days
    21	archive vcd-dump 7
    22	# Archive vcd-report data which is older than 31 days
    23	archive vcd-report 31
\end{verbatim}
}
\$VCDDATA/vcd-dump配下のデータについては７日前、\$VCDDATA/vcd-report配下のデータについては
３１日前より古いデータが、圧縮されたtarアーカイブに変換され、archiveディレクトリに移動します。
（21行目と23行目）何らかの理由でアーカイブ作成に失敗した場合には元のディレクトリはそのまま残ります
（14行目から16行目までの\&\&で連結されたコマンド）。
\end{document}
