\documentclass[10pt,a4paper]{jarticle}

\newcommand{\thetitle}{vCloud Datacenter Toolkit - Users Guide}
\newcommand{\theauthor}{Kaoru Fukumoto}
\newcommand{\email}{kfukumot@vmware.com}
\newcommand{\version}{0.1}
\newcommand{\customer}{SoftBank Telecom}
\newcommand{\COMMON}{../common}

\input{\COMMON/packages}
\input{\COMMON/style}
\usepackage{booktabs}
\usepackage{hyperref}

\begin{document}
\CoverPage

\pagenumbering{roman}
\section*{改版履歴}
\begin{tabular}{|cccp{5cm}|}
\hline
\rowcolor[gray]{.8} \textbf{変更日} & 
\textbf{\small バージョン} & 
\textbf{変更者} & 
\textbf{コメント}\\

2011/07/25 & 0.1 & 福本　薫 & 
最初のバージョン\\

\hline
\end{tabular}

\newpage
\tableofcontents

\newpage
\pagenumbering{arabic}
\section{インストール}

\subsection{システム要件}
vcdkitをインストールするためには各種Liunx系OSもしくはMac OSXと以下のruby実行環境が必要です。
\begin{itemize}
\item ruby (version 1.8.7 以降)
\item ruby gem (version 1.3.5 以降)
\item ruby gem パッケージ
  \begin{itemize}
  \item crypt 
  \item highline
  \item rbvmomi
  \item rest-client
  \end{itemize}
\end{itemize}

\subsection{インストール手順}
vcdkit のインストールは vcdkit を利用するアカウントで行います。root 権限は必要ありません。
\begin{enumerate}
\item 配布パッケージ(vcdkit-x.x.tgz)をインストール先サーバのローカルディスクにコピー。
\item 配布パッケージをインストールディレクトリ配下に展開。\\
/opt/vmware/vcdkitディレクトリにインストールする例を以下に示します。
以下インストールディレクトリを\$VCDKITとして参照します。
\begin{verbatim}
$ cd /opt/vmware/vcdkit
$ tar zcvf /tmp/vcdkit-0.1.tgz
\end{verbatim}

\item 環境変数 VCDKITを設定。\\
vcdkitのコマンドを実行するためには環境変数 \$VCDKIT を設定する必要があります。
また、すべてのコマンドは \$VCDKIT ディレクトリ直下にインストールされるので、
PATH変数に \$ VCDKITを追加する事をお勧めします。.bashrcの編集例を以下に示します。
 \begin{verbatim}
export VCDKIT=/opt/vmware/vcdkit
export PATH=$VCDKIT:$PATH
\end{verbatim}

\item 暗号化されたパスワードの保存。\\
vCloud Datacenterの各種システムへ接続する際に使用するパスワードを、暗号化した上でローカルディスクに保存します。
保存されたパスワードファイルは vcdkit 利用アカウントと root アカウントのみが読み取り出来るように設定する事を推奨します。

以下に設定例を示します。パスワードファイルはシステム毎に\$VCDKITディレクトリ直下に保存されます。

 \begin{verbatim}
$ vcd-pass.rb -vcb
Enter vCloud Director password: ********
Enter vCenter password: ********
Enter vCenter Chargeback password: ********
$ chmod go-r $VCDKIT/.vc*
\end{verbatim}

\item cronジョブの設定。\\
vApp設定のリストアを行うためにバックアップジョブのスケジュールと同期して vcd-dump.rbを実行します。
\$VCDKIT/cron/crontab.conf には標準的な毎時バックアップのスケジュール例が記述されています。
crontab.conf を適切に編集後、crontab コマンドで cron ジョブをスケジュールします。

 \begin{verbatim}
$ crontab $VCDKIT/cron/crontab.conf
$ crontab -l
0 * * * * /opt/vmware/vcdkit/cron/vcd-dump.sh
15 * * * * /opt/vmware/vcdkit/cron/vcd-report.sh
30 * * * * /opt/vmware/vcdkit/cron/archive.sh
45 * * * * /opt/vmware/vcdkit/cron/vcd-ex.sh
\end{verbatim}

\end{enumerate}

\section{コマンド} 
%
% vcd-dump.rb
%
\subsection{vcd-dump.rb} 
vCloud DirectorとvCenterからデータの抽出を行います。

\subsubsection{使用例}
\paragraph{フェーズ２環境すべてのデータを自動タイムスタンプ付きディレクトリにダンプする。}

\begin{verbatim}
$ vcd-dump-rb -v2 -c2 -l $VCDKIT/logs/vcd-dump.log
\end{verbatim}

{\tt -v2 -c2} オプションは vCloud Director, vCenter 共にフェーズ２本番環境を利用する事を指定します。
ダンプデータは \$VCDKIT/data/vcd-report/TIMESTAMP 以下に保存されます。
TIMESTAMP の生成にはコマンド実行開始時の時間が利用されます。（例：2011-07-20\_12-00-00）

{\tt -l} オプションはログ出力先ファイルを指定します。無指定の場合は標準出力に出力されます。

\subsubsection{データファイルの構造}
vcd-dump.rb は \$VCDKIT/data/vcd-dump/TIMESTAMP 配下に以下の形で抽出データをダンプします。
データファイルはすべて vCloud API を用いて取得されるオブジェクト毎の XML形式です。
\footnote{XMLデータの詳細についてはvCloud APIの仕様を参照ください。
\url{http://communities.vmware.com/community/vmtn/developer/forums/vcloudapi}}

{\footnotesize
\begin{verbatim}
$VCDKIT/data/vcd-dump/TIMESTAMP
`-- ORG
  |-- VCD.xml
  |-- VCenter.xml
  `-- [Org Name]
     |-- Org.xml
     |-- VDC
     | `-- [vDC Name]
     |   |-- Vdc.xml
     |   |-- VAPP
     |   | `-- [vApp Name]
     |   |   |-- VApp.xml
     |   |   |-- ControlAccessParams.xml
     |   |   `-- VM
     |   |     `-- [VM Name]
     |   |       `-- Vm.xml     
     |   `-- VAPPTEMPLATE
     |     `-- [vApp Template Name]
     |       |-- VAppTemplate.xml
     |       `-- VMTEMPLATE
     |         `-- [VM Template Name]
     |            `-- VmTempalte.xml     
     |-- CATALOG
     | `-- Public
     |    |-- Catalog.xml
     |    `-- CATALOGITEM
     |      `-- [Catalog Item Name]
     |        `-- CatalogItem.xml
     `-- USER
       `-- [User Name]
         `-- User.xml
\end{verbatim}
}

\subsubsection{コマンドオプション一覧}
利用できるコマンドオプションの一覧は引数に{\tt -h}を指定すると表示されます。

{\footnotesize
\begin{verbatim}
$ vcd-dump.rb -h
Usage: vcd-dump.rb [options]
    -v, --vcd HOST,ORG,USER          vCD login parameters
    -c, --vcenter HOST,USER          vCenter login parameters
    -A, --all                        Dump all data
    -a, --vapp ORG,VDC,VAPP          Dump specified vApp data
    -o, --org ORG                    Dump specified organization data
    -t, --tree TREENAME              Dump tree directory name
    -l, --logfile LOGFILEPATH        Log file name
    -h, --help                       Display this help
\end{verbatim}
}

%
% vcd-report.rb
%
\subsection{vcd-report.rb} 
vcd-dump.rb で抽出した XMLデータをもとに各種レポート作成します。

\subsubsection{使用例}
\paragraph{レポート未作成のすべてのダンプデータからレポートを作成する。}

\begin{verbatim}
$ vcd-report.rb
\end{verbatim}

vcd-report.rb はデフォルトで \$VCDKIT/data/vcd-dump以下のすべてのディレクトリを検索し、
\$VCDKIT/data/vcd-report 以下にレポートを作成します。（例：\$VCDKIT/data/vcd-dump/2011-07-01\_00-00-00
のレポートを \$VCDKIT/data/vcd-report/2011-07-01\_00-00-00に作成）既にレポート作成が行われている
ダンプデータはスキップされます。

\subsubsection{データファイルの構造}
vcd-report.rb は \$VCDKIT/data/vcd-report 配下に以下の形で各種レポートファイルを作成します。

{\footnotesize
\begin{verbatim}
$VCDKIT/data/vcd-report/TIMESTAMP
`-- ORG
   |-- VMList.xml
   |-- MediaList.xml
   `-- [Org Name]
     `-- VDC
       `-- [vDC Name]
         |-- VAPP
         | `-- [vApp Name]
         |   |-- VAppParams.xml
         |   `-- VM
         |     `-- [VM Name]
         |       `-- VmParams.xml     
         `-- VAPPTEMPLATE
           `-- [vApp Template Name]
             |-- VAppTemplateParams.xml
             `-- VMTEMPLATE
               `-- [VM Template Name]
                  `-- VmTemplateParams.xml     

\end{verbatim}
}

\subsubsection{作成されるレポートの種類}

\begin{table}[H]
\begin{tabular}{lm{6.5cm}}
\toprule
\textbf{ファイル名}　& \textbf{説明} \\ 
\midrule
VMList.xml & 仮想マシンのインベントリ一覧 \\
MediaList.xml & メディアのインベントリ一覧 \\
vAppParams.xml & vAppのパラメータ一覧 \\
VmParams.xml  & vApp内仮想マシンのパラメータ一覧 \\
vAppTemplateParams.xml & vApp Templateのパラメータ一覧 \\
VmTemplateParams.xml & vApp Template内仮想マシンのパラメータ一覧 \\
\bottomrule
\end{tabular}
\end{table}

\subsubsection{コマンドオプション一覧}
利用できるコマンドオプションの一覧は引数に{\tt -h}を指定すると表示されます。

{\footnotesize
\begin{verbatim}
$ vcd-report.rb -h
Usage: vcd-report.rb [cmd-options]
    -v, --vcd HOST,ORG,USER          vCD login parameters
    -i, --input DIR                  Specify root directory of the vCD dump data
    -o, --output DIR                 Specify directory for reports
    -a, --vapp ORG,VDC,VAPP          Create report for vApp
    -T ORG,VDC,VAPPTEMPLATE          Create report for vApp Template
        --vapptemplate
    -A, --all                        Create report for entire dump tree
    -t, --tree TREENAME              Directory name to identify dump tree
    -f, --force                      Force to recreate reports to exisiting tree
    -l, --logfile LOGFILEPATH        Log file name
    -h, --help                       Display this help
\end{verbatim}
}

%
% vcd-restore.rb
%
\subsection{vcd-restore.rb} 
vcd-dump.rb で抽出した XMLデータをもとにvApp設定情報のリストアを行います。

\subsubsection{使用例}
\paragraph{リストア日時とvApp名を指定してvApp設定情報をリストアする（インタラクティブモード）}

\begin{description}
\item[ステップ1] ターゲットの指定
\end{description}

{\footnotesize
\begin{verbatim}
$ vcd-report.rb
Select restart target directory:
1. 2011-07-26_20-04-10
2. Specify date
3. Change name pattern. Current pattern='*'
?  1
Enter vApp name pattern: RESTORE
Select VAPP:
1. CustomerDemo-02 | Basic Backup - Customer Demo-02 | RESTORE-000
2. CustomerDemo-02 | Basic Backup - Customer Demo-02 | RESTORE-001
3. Change name pattern. Current pattern='*RESTORE*'
?  2
\end{verbatim}
}

\begin{description}
\item[ステップ2] 現時点での差分表示、およびリストア実行の確認
\end{description}

{\footnotesize
\begin{verbatim}
...
（vApp情報取得動作のログ）
...
***************
*** 4,10 ****
        DB-02
      </FullName>
      <Description>
!       Testing..
      </Description>
      <OperatingSystemType>
         winNetEnterpriseGuest 
--- 4,10 ----
        DB-02
      </FullName>
      <Description>
!       CHANGE DESCRIPTION
      </Description>
      <OperatingSystemType>
         winNetEnterpriseGuest 
<<
Continue (yN)? y
\end{verbatim}
}

\begin{description}
\item[ステップ3] リストア実施、およびリストア完了後の差分表示
\end{description}
{\footnotesize
\begin{verbatim}
...
（vAppリストア動作のログ）
...
2011-07-26 21:22:03 | INFO | [DIFF AFTER RESTORE]: >><<
\end{verbatim}
}

\subsubsection{コマンドオプション一覧}
利用できるコマンドオプションの一覧は引数に{\tt -h}を指定すると表示されます。

{\footnotesize
\begin{verbatim}
$ vcd-restore.rb -h
Usage: vcd-restore.rb [cmd-options]
    -v, --vcd HOST,ORG,USER          vCD login parameters
    -i, --input DIR                  Root directory of the vCD dump data
    -t, --tree TREENAME              Directory name to identify dump tree
    -o, --output DIR                 Specify directory for reports
    -a, --vapp ORG,VDC,VAPP          Restore source vApp
    -l, --logfile LOGFILEPATH        Log file name
    -h, --help                       Display this help

\end{verbatim}
}

%
% vcd-ex.rb
%
\subsection{vcd-ex.rb}
vCloud Director Cell と vCenter 間、および vCloud Director Cellと ESXホスト間のセッションを維持するために以下の操作を行います。

\begin{itemize}
\item vAppのリスタート
\item 仮想マシンサムネールの取得
\end{itemize}

このコマンドはファイアウォールによるアイドルコネクションタイムアウトによる接続障害を回避する目的で
使用されます。ファイアウォールのタイムアウト間隔より十分短い間隔で実行する必要があります。

\subsubsection{操作対象となるvApp}

vCloud Director CellとすべてのESXi ホスト間でのセッションを維持するために、各ESXiに
サムネール取得対象のVMを配置する必要があります。以下に現在の配置状態を記します。
(各仮想マシンはDRSのアフィニティルールを用いてホストに紐付けされています)

\begin{table}[H]
\begin{tabular}{lllll}
\toprule
\textbf{ORG}　& \textbf{VDC} & \textbf{VAPP} & \textbf{VM} & \textbf{ESX} \\ 
\midrule
Admin & Basic - Admin & VCDEX-B01 & VCDEX-158$\sim$ &  CGSdhb-158$\sim$ \\
 &  &  & VCDEX-171 &  CGSdhb-171 \\
Admin & Basic Backup - Admin & VCDEX-BB01 & VCDEX-172$\sim$ &  CGSdhb-172$\sim$ \\
 &  &  & VCDEX-177 &  CGSdhb-177 \\
Admin & Committed - Admin & VCDEX-C01 & VCDEX-138$\sim$ &  CGSdhb-138$\sim$ \\
 &  &  & VCDEX-151 &  CGSdhb-151 \\
Admin & Committed Backup - Admin & VCDEX-CB01 & VCDEX-152$\sim$ &  CGSdhb-152$\sim$ \\
 &  &  & VCDEX-157 &  CGSdhb-157 \\
\bottomrule
\end{tabular}
\end{table}
\end{document}
